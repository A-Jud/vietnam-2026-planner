<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×•×™×™×˜× ×× 2026 - ×××•×‘×˜×—</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        #app-container { display: flex; height: 100dvh; width: 100vw; overflow: hidden; flex-direction: row-reverse; }
        #map-container { flex: 1; height: 100%; position: relative; z-index: 1; }
        #itinerary-container { width: 50vw; min-width: 380px; max-width: 100vw; height: 100%; background: white; box-shadow: -4px 0 15px rgba(0,0,0,0.05); z-index: 10; display: flex; flex-direction: column; position: relative; min-height: 0; overflow: hidden; }
        #resizer { background-color: #e2e8f0; display: flex; align-items: center; justify-content: center; z-index: 20; transition: background-color 0.2s; flex-shrink: 0; cursor: col-resize; }
        #resizer:active { background-color: #94a3b8; }
        .resizer-line { background: white; border-radius: 2px; }
        
        @media (min-width: 769px) { #resizer { width: 12px; flex-direction: column; } .resizer-line { width: 2px; height: 20px; margin: 2px 0; } }
        @media (max-width: 768px) { #app-container { flex-direction: column; } #map-container { height: 30vh; width: 100%; flex: none; } #resizer { height: 16px; width: 100%; cursor: row-resize; flex-direction: row; } .resizer-line { height: 2px; width: 24px; margin: 0 3px; } #itinerary-container { width: 100%; height: 70vh; flex: none; } }
        #map { height: 100%; width: 100%; }
        #timeline-container { flex: 1; overflow-y: auto !important; padding: 1.5rem; min-height: 0; display: block; }
        
        .day-card { border-right: 3px solid #e2e8f0; margin-right: 12px; padding-right: 20px; position: relative; padding-bottom: 1.5rem; text-align: right; }
        .day-card.active { border-right-color: #4f46e5; background-color: #f8fafc; border-radius: 12px 0 0 12px; }
        .day-dot { position: absolute; right: -10px; top: 0; width: 17px; height: 17px; border-radius: 50%; background: white; border: 3px solid #cbd5e1; }
        .day-card.active .day-dot { border-color: #4f46e5; background: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
        
        .option-box { border: 1px solid #e2e8f0; padding: 8px 10px; border-radius: 10px; margin-bottom: 6px; cursor: pointer; background: white; display: flex; align-items: flex-start; gap: 10px; transition: all 0.2s; }
        .option-box.selected { border-color: #4f46e5; background-color: #f5f3ff; border-width: 2px; }
        .option-box:hover { border-color: #a5b4fc; }
        
        #ai-overlay { position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); backdrop-filter: blur(8px); z-index: 50; transform: translateY(100%); opacity: 0; visibility: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; pointer-events: none; }
        #ai-overlay.open { transform: translateY(0); opacity: 1; visibility: visible; pointer-events: auto; }
        .custom-div-icon { background-color: #4f46e5; color: white; border-radius: 50%; border: 3px solid white; text-align: center; font-weight: bold; line-height: 24px; cursor: pointer; }
        
        /* Scrollbar hiding for tabs */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="map-container">
        <div id="map"></div>
        <div id="iframe-wrapper" class="hidden absolute inset-0 z-[2000] bg-white flex flex-col shadow-[inset_0_0_10px_rgba(0,0,0,0.1)]">
            <div class="bg-gray-100 p-2.5 flex justify-between items-center border-b border-gray-300 shrink-0">
                <button onclick="window.closeIframe()" class="text-xs font-bold bg-white border border-gray-300 hover:bg-gray-200 text-gray-700 px-4 py-1.5 rounded-full flex items-center gap-1.5 transition-colors shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    ×¡×’×•×¨ ×•×—×–×•×¨ ×œ××¤×”
                </button>
                <button id="iframe-popout-btn" onclick="window.openCurrentInNewTab()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 px-3 py-1.5 flex items-center gap-1.5 transition-colors">
                    ×¤×ª×— ×‘×“×¤×“×¤×Ÿ
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </button>
            </div>
            <iframe id="content-iframe" class="flex-1 w-full h-full border-none bg-gray-50" src=""></iframe>
        </div>
    </div>
    <div id="resizer"><div class="resizer-line"></div><div class="resizer-line"></div></div>
    <div id="itinerary-container">
        <div class="px-6 py-5 border-b border-gray-100 bg-white shrink-0 flex justify-between items-center z-20 relative">
            <div class="text-right">
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    ×•×™×™×˜× ×× 2026
                    <span title="×”××™×“×¢ ×©××•×¨ ×‘×ª×™×§×™×™×” ×¤×¨×˜×™×ª ×‘×“×¨×™×™×‘" class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full font-bold">ğŸ›¡ï¸ ××™×“×¢ ×¤×¨×˜×™</span>
                </h1>
                <div class="flex items-center gap-2 mt-1 justify-end">
                    <p class="text-sm text-gray-700 flex items-center gap-1">
                        30 ×‘××¨×¥ - 11 ×‘××¤×¨×™×œ â€¢ <span id="sync-status" class="text-gray-500 font-bold">â³ ×××ª×—×œ...</span>
                    </p>
                    <button id="auth-btn" onclick="window.loginGoogle()" class="hidden text-xs font-bold bg-blue-100 text-blue-800 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg>
                        ×”×ª×—×‘×¨ ×¢× Google
                    </button>
                </div>
            </div>
            <button onclick="window.openApiModal()" class="text-gray-400 hover:text-indigo-600 p-2 transition-colors" title="×”×’×“×¨×•×ª ×•××“××™× ×™×¡×˜×¨×¦×™×”">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2"></path></svg>
            </button>
        </div>
        <div id="timeline-container" class="custom-scroll"></div>
        <div id="ai-overlay">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-indigo-50 shrink-0">
                <h3 class="font-bold text-indigo-900 flex items-center gap-2"><span>âœ¨</span> <span id="active-provider-label">×”××œ×¦×•×ª AI</span></h3>
                <button onclick="window.closeAIPanel()" class="p-2 hover:bg-white rounded-full text-gray-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 text-right" id="ai-content">
                <div id="ai-loading" class="hidden text-center mt-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-indigo-600 font-medium italic">×”-AI ×—×•×©×‘ ×•××¤×¢× ×—...</p>
                </div>
                <div id="ai-results" class="hidden space-y-4"></div>
                <div id="ai-error-box" class="hidden mt-6 p-4 bg-black rounded-xl text-green-400 text-[10px] font-mono text-left dir-ltr overflow-auto max-h-60 border border-gray-700 shadow-xl">
                    <div class="text-red-500 font-bold mb-2">RAW ERROR RESPONSE:</div>
                    <div id="error-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generic Alert Modal -->
<div id="alert-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden text-right p-6">
        <h2 id="alert-modal-title" class="text-lg font-bold mb-2 text-gray-800">×”×•×“×¢×”</h2>
        <p id="alert-modal-msg" class="text-sm text-gray-600 mb-5"></p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="w-full py-2.5 font-bold bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors">×”×‘× ×ª×™</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden text-right p-6">
        <h2 id="confirm-modal-title" class="text-lg font-bold mb-2 text-gray-800">××™×©×•×¨ ×¤×¢×•×œ×”</h2>
        <p id="confirm-modal-msg" class="text-sm text-gray-600 mb-5"></p>
        <div class="flex gap-2">
            <button id="confirm-modal-yes" class="flex-1 py-2.5 font-bold bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors">××™×©×•×¨</button>
            <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="flex-1 py-2.5 font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<!-- Route Generation Modal -->
<div id="route-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden text-right p-6">
        <h2 class="text-lg font-bold mb-2 text-gray-800 flex items-center gap-2"><span>ğŸ—ºï¸</span> ××¡×œ×•×œ × ×™×•×•×˜ ×™×•××™</h2>
        <p class="text-xs text-gray-600 mb-5 leading-relaxed">×”××¡×œ×•×œ ×—×•×©×‘ ×‘×”×¦×œ×—×”. ×”×•× ×›×•×œ×œ ××ª × ×§×•×“×ª ×”××•×¦×, ×”×™×¢×“ ×”×™×•××™, ×•××ª ×›×œ ×”××˜×¨×§×¦×™×•×ª ×•×”×˜×™×¤×™× ×©×©××¨×ª ×œ×™×•× ×–×” ×œ×¤×™ ×”×¡×“×¨ (××‘×•×¡×¡ ×¢×œ ×©××•×ª ×‘×× ×’×œ×™×ª).</p>
        <input type="hidden" id="route-modal-url">
        
        <div class="flex flex-col gap-3">
            <button onclick="window.handleRouteAction('browser')" class="w-full py-3 font-bold bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                ×”×¢×ª×§ ×œ×™× ×§ ×•×¤×ª×— ×‘×“×¤×“×¤×Ÿ
            </button>
            <button onclick="window.handleRouteAction('iframe')" class="w-full py-3 font-bold bg-indigo-100 text-indigo-800 rounded-xl hover:bg-indigo-200 transition-colors shadow-sm flex justify-center items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2zM5 10.5C3.895 10.5 3 11.395 3 12.5s.895 2 2 2 2-.895 2-2-.895-2-2-2z"></path></svg>
                ×¤×ª×— ×‘×ª×•×š ×”××¤×œ×™×§×¦×™×”
            </button>
            <button onclick="document.getElementById('route-modal').classList.add('hidden')" class="w-full py-2.5 font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors mt-1">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<!-- Modal Edit Custom Option -->
<div id="edit-option-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm text-right p-6 max-h-[90vh] overflow-y-auto">
        <h2 id="edit-option-modal-title" class="text-xl font-bold mb-4 text-gray-800">×¢×¨×™×›×ª ××¤×©×¨×•×ª ×¤×¢×™×œ×•×ª</h2>
        <input type="hidden" id="edit-opt-dayidx">
        <input type="hidden" id="edit-opt-id">
        <div class="mb-3">
            <label class="text-[10px] font-bold text-gray-500">×©× ×”×¤×¢×™×œ×•×ª (×¢×‘×¨×™×ª)</label>
            <input type="text" id="edit-opt-t" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2 text-sm outline-none">
        </div>
        <div class="mb-3">
            <label class="text-[10px] font-bold text-gray-500">×©× ×‘×× ×’×œ×™×ª (×—×©×•×‘ ×¢×‘×•×¨ ××¤×•×ª Google)</label>
            <input type="text" id="edit-opt-en-t" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2 text-sm outline-none text-left" dir="ltr">
        </div>
        <div class="mb-3">
            <label class="text-[10px] font-bold text-gray-500">×ª×™××•×¨</label>
            <textarea id="edit-opt-d" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2 text-sm outline-none resize-none h-20"></textarea>
        </div>
        <div class="mb-5">
            <label class="text-[10px] font-bold text-gray-500">×§×™×©×•×¨ (Google Maps ××• ××ª×¨)</label>
            <input type="text" id="edit-opt-u" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2 text-sm outline-none text-left" dir="ltr">
        </div>
        <div class="flex gap-2">
            <button onclick="window.saveEditedOption()" class="flex-1 py-3 font-bold bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors">×©××•×¨</button>
            <button onclick="window.closeEditModal()" class="px-6 py-3 font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<!-- Admin / Settings Modal -->
<div id="api-key-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md text-right flex flex-col max-h-[90vh]">
        
        <!-- Header Tabs -->
        <div class="flex border-b bg-gray-50 shrink-0 text-xs overflow-x-auto hide-scroll rounded-t-2xl">
            <button onclick="switchAdminTab('gemini')" id="tab-gemini" class="whitespace-nowrap flex-1 px-3 py-3.5 font-bold border-b-2 text-indigo-600 border-indigo-600 bg-indigo-50 transition-all">Gemini</button>
            <button onclick="switchAdminTab('openai')" id="tab-openai" class="whitespace-nowrap flex-1 px-3 py-3.5 font-bold border-b-2 text-gray-500 border-transparent hover:bg-gray-100 transition-all">OpenAI</button>
            <button onclick="switchAdminTab('prompts')" id="tab-prompts" class="whitespace-nowrap flex-1 px-3 py-3.5 font-bold border-b-2 text-gray-500 border-transparent hover:bg-gray-100 transition-all">×¤×¨×•××¤×˜×™×</button>
            <button onclick="switchAdminTab('tools')" id="tab-tools" class="whitespace-nowrap flex-1 px-3 py-3.5 font-bold border-b-2 text-gray-500 border-transparent hover:bg-gray-100 transition-all">×›×œ×™×</button>
        </div>

        <div class="p-5 overflow-y-auto">
            
            <!-- Gemini Section -->
            <div id="config-gemini">
                <p class="text-xs text-gray-500 mb-3">×”××¤×ª×— ×™×•×¦×¤×Ÿ ×‘×“×¤×“×¤×Ÿ ×‘×××¦×¢×•×ª AES-GCM.</p>
                <input type="password" id="gemini-key-input" placeholder="AIzaSy..." class="w-full border-2 border-gray-200 focus:border-indigo-500 outline-none rounded-xl px-4 py-2.5 text-sm mb-3 font-mono text-left" dir="ltr">
                <div class="mb-3">
                    <label class="text-[10px] font-bold text-gray-400 block mb-1">××•×“×œ ××•×¢×“×£:</label>
                    <select id="gemini-model-select" class="w-full border-2 border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-indigo-500">
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (××•××œ×¥)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (×™×¦×™×‘)</option>
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                    </select>
                </div>
            </div>

            <!-- OpenAI Section -->
            <div id="config-openai" class="hidden">
                <p class="text-xs text-gray-500 mb-3">×”××¤×ª×— ×™×•×¦×¤×Ÿ ×‘×“×¤×“×¤×Ÿ ×‘×××¦×¢×•×ª AES-GCM.</p>
                <input type="password" id="openai-key-input" placeholder="sk-..." class="w-full border-2 border-gray-200 focus:border-indigo-500 outline-none rounded-xl px-4 py-2.5 text-sm mb-3 font-mono text-left" dir="ltr">
                <div class="mb-3">
                    <label class="text-[10px] font-bold text-gray-400 block mb-1">××•×“×œ ××•×¢×“×£:</label>
                    <select id="openai-model-select" class="w-full border-2 border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-indigo-500">
                        <option value="gpt-5.2">GPT-5.2 (×”×›×™ ×—×“×© ×•××ª×§×“×)</option>
                        <option value="gpt-5">GPT-5 (×™×¦×™×‘ ×•××”×™×¨)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (×’×¨×¡×” ×§×•×“××ª)</option>
                    </select>
                </div>
            </div>

            <!-- Prompts Section -->
            <div id="config-prompts" class="hidden">
                <p class="text-[11px] text-gray-500 mb-3 leading-relaxed">
                    ×”×’×“×¨ ××ª ×”×”× ×—×™×•×ª ×©×™×©×œ×—×• ×œ-AI. ×”××¢×¨×›×ª ×ª×—×œ×™×£ ××•×˜×•××˜×™×ª ××ª ×”×ª×’×™×•×ª ×”×‘××•×ª: <br>
                    <span class="font-bold text-gray-700">×¤×¨××˜×¨ ×—×•×‘×”:</span> 
                    <code class="bg-gray-100 text-pink-600 px-1 rounded font-bold">&lt;×©×_×‘×× ×’×œ×™×ª&gt;</code> <span class="text-gray-400">(× ×œ×§×— ×× ×ª×•× ×™ ×”×™×¢×“)</span><br>
                    <span class="font-bold text-gray-700">×¤×¨××˜×¨×™ ×¨×©×•×ª:</span> 
                    <code class="bg-gray-100 text-blue-600 px-1 rounded font-bold">&lt;×™×¢×“&gt;</code> , 
                    <code class="bg-gray-100 text-blue-600 px-1 rounded font-bold">&lt;××•×¦×&gt;</code> , 
                    <code class="bg-gray-100 text-blue-600 px-1 rounded font-bold">&lt;×ª××¨×™×š&gt;</code> , 
                    <code class="bg-gray-100 text-blue-600 px-1 rounded font-bold">&lt;×ª×™××•×¨&gt;</code>.
                    <br><span class="text-red-500 font-bold mt-1 block">âš ï¸ ×—×•×‘×” ×œ×”×©××™×¨ ××ª ×”××‘× ×” ×©×œ ×”-JSON ×‘×¡×•×£ ×›×•×œ×œ ×”×©×“×•×ª ×‘×× ×’×œ×™×ª ×›×“×™ ×©×”××¤×” ×ª×¢×‘×•×“!</span>
                </p>
                
                <label class="text-xs font-bold text-indigo-800 block mb-1">×¤×¨×•××¤×˜ - ×˜×™×¤×™× ×œ×™×¢×“:</label>
                <textarea id="prompt-tips-input" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2 text-[11px] mb-3 h-28 font-mono text-left outline-none resize-y" dir="ltr"></textarea>

                <label class="text-xs font-bold text-teal-800 block mb-1">×¤×¨×•××¤×˜ - ××¤×©×¨×•×™×•×ª ××¡×œ×•×œ (AI):</label>
                <textarea id="prompt-options-input" class="w-full border-2 border-gray-200 focus:border-teal-500 rounded-xl px-3 py-2 text-[11px] mb-1 h-28 font-mono text-left outline-none resize-y" dir="ltr"></textarea>
            </div>

            <!-- Tools / Encryption Section -->
            <div id="config-tools" class="hidden">
                <p class="text-sm font-bold text-gray-800 mb-1">×”×¦×¤× ×ª ××¤×ª×— ×’×™×‘×•×™</p>
                <p class="text-[11px] text-gray-500 mb-4 leading-relaxed">
                    ×›×œ×™ ×–×” ×××¤×©×¨ ×œ×š ×œ×”×¦×¤×™×Ÿ ××ª ××¤×ª×— ×”-API ×©×œ×š. ×›×š ×ª×•×›×œ ×œ×”×“×‘×™×§ ××ª ×”×ª×•×¦××” ×”××•×¦×¤× ×ª ×‘×ª×•×š ×§×•×“ ×”××§×•×¨ (×‘××©×ª× ×” <code class="font-bold text-gray-700">FALLBACK_OAI_KEY</code>) ×•×œ×”×¢×œ×•×ª ×œ-GitHub ×œ×œ× ×—×©×© ××‘×•×˜×™× ×©×¡×•×¨×§×™× ××¤×ª×—×•×ª ×’×œ×•×™×™×.
                </p>
                <input type="password" id="raw-fallback-input" placeholder="×”×“×‘×§ ××¤×ª×— ××§×•×¨×™ ×›××Ÿ (sk-...)" class="w-full border-2 border-gray-200 focus:border-indigo-500 rounded-xl px-3 py-2.5 text-xs mb-2 font-mono text-left outline-none" dir="ltr">
                <button onclick="window.generateEncryptedFallback()" class="w-full py-2.5 font-bold bg-gray-800 text-white rounded-xl mb-4 hover:bg-gray-900 transition-colors text-xs shadow-sm">×”×¦×¤×Ÿ ××¤×ª×—</button>
                
                <label class="text-[10px] font-bold text-gray-400 block mb-1">×ª×•×¦××” ××•×¦×¤× ×ª (×œ×”×¢×ª×§×” ×œ×§×•×“ ×”××§×•×¨):</label>
                <textarea id="encrypted-fallback-output" readonly class="w-full border-2 border-green-200 bg-green-50 text-green-800 rounded-xl px-3 py-2 text-[10px] h-20 font-mono text-left outline-none resize-none cursor-copy" dir="ltr" onclick="this.select()"></textarea>
            </div>

            <!-- Always visible Provider Select -->
            <div id="provider-selector-box" class="bg-indigo-50 p-3 rounded-xl my-4 flex items-center justify-between flex-row-reverse border border-indigo-100">
                <span class="text-xs font-bold text-indigo-900">×¡×¤×§ ×¤×¢×™×œ:</span>
                <select id="active-provider-select" class="bg-white border border-indigo-200 rounded-lg px-2 py-1 text-xs font-bold text-indigo-600 outline-none">
                    <option value="gemini">Gemini</option>
                    <option value="openai">OpenAI</option>
                </select>
            </div>

            <div id="test-key-result" class="hidden mb-3 p-2.5 rounded-xl text-xs font-bold text-center"></div>

            <div class="flex flex-col gap-2 mt-auto">
                <button id="btn-test-key" onclick="window.testActiveApiKey()" class="w-full py-2.5 font-bold text-indigo-600 border-2 border-indigo-100 rounded-xl hover:bg-indigo-50 transition-colors">×‘×“×•×§ ×ª×§×™× ×•×ª ××¤×ª×—</button>
                <div class="flex gap-2">
                    <button onclick="window.saveAllConfig()" class="flex-1 py-2.5 font-bold bg-indigo-600 text-white rounded-xl active:scale-95 transition-transform shadow-md">×©××•×¨ ×”×’×“×¨×•×ª</button>
                    <button onclick="window.closeApiModal()" class="px-6 py-2.5 font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">×¡×’×•×¨</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script type="module">
    // ------------------------------------------------------------------------
    // GOOGLE DRIVE API CONFIGURATION
    // ------------------------------------------------------------------------
    const CLIENT_ID = "449350453148-rptakuolagf5deu5rn8u9ep1o76lmqj4.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.file"; 
    
    // ××¤×ª×— ×’×™×‘×•×™ ×©×œ OpenAI
    const FALLBACK_OAI_KEY = "ENC_AES_GCM:2HSFwAqFaXYigLET:rj5wKlL6OEzLDEPUao+6k9YXNZ9W3aXGxX68Y3qtjDKoyqzhAJ3WjmdPdBIuE2lTmvC6W7pzQJxFRagcVc9uIrDGPzZHrAhZjbr44qV3WSaiPYzz15U+bmoCig0FNpvs67i4B2ntuhI3+VfjeUNWKyx/JUIrSSzgu9Uz6NsWMOqME78AOWZylScbvlYSdbcqNFRT9W8MPaH0fAaRwGUqmQCy/tZ67JRL9Rf1ptn7ohHtaFB+";

    // ×§×‘×•×¢×™× ×¢×‘×•×¨ ×”×ª×™×§×™×™×” ×•×”×§×•×‘×¥ ×‘×“×¨×™×™×‘
    const FOLDER_NAME = "Vietnam 2026 Planner";
    const FILE_NAME = "vietnam_trip_data.json";

    // ×¤×¨×•××¤×˜×™× ×‘×¨×™×¨×ª ××—×“×œ ××¢×•×“×›× ×™× ×¢× ×‘×§×©×” ××¤×•×¨×©×ª ×œ×©× ×‘×× ×’×œ×™×ª ×•×”×¤×¨×“×” ×‘×™×Ÿ ×—×•×‘×” ×œ×¨×©×•×ª
    const defaultTipsPrompt = "Travel Vietnam 2026.\nDestination (English): <×©×_×‘×× ×’×œ×™×ª>\n[Optional] Destination (Hebrew): <×™×¢×“>\n[Optional] Date: <×ª××¨×™×š>\n[Optional] Context: <×ª×™××•×¨>\nSuggest 2 hidden gems in Hebrew. JSON format ONLY: {\"tips\":[{\"title\":\"Hebrew name\",\"en_title\":\"English Name (Crucial for Maps)\",\"emoji\":\"ğŸš€\",\"text\":\"desc\",\"url\":\"map link\"}]}. URLs must be full Google Maps.";
    const defaultOptionsPrompt = "Travel Vietnam 2026.\nDestination (English): <×©×_×‘×× ×’×œ×™×ª>\n[Optional] Destination (Hebrew): <×™×¢×“>\n[Optional] Date: <×ª××¨×™×š>\n[Optional] Context: <×ª×™××•×¨>\nGenerate exactly 3 different daily activity options/itineraries for this day in Hebrew. Include real places. JSON format ONLY: {\"options\":[{\"t\":\"Hebrew title\",\"en_t\":\"English title (Crucial for Maps)\",\"d\":\"short description\",\"u\":\"google maps url\"}]}.";

    let accessToken = null;
    let driveFolderId = null;
    let driveFileId = null;
    
    // --- Iframe / Map Overlay Logic ---
    let currentIframeUrl = '';
    window.openInIframe = (url) => {
        if (!url) return;
        currentIframeUrl = url;
        let embedUrl = url;
        let shouldEmbed = true;
        
        try {
            let u = new URL(url);
            if (u.hostname.includes('google') && (u.pathname.includes('maps') || u.hostname.includes('maps'))) {
                if (u.pathname.includes('/dir/')) {
                    const origin = u.searchParams.get('origin');
                    const dest = u.searchParams.get('destination');
                    const wp = u.searchParams.get('waypoints');
                    
                    const encodedOrigin = encodeURIComponent(origin);
                    const encodedDest = encodeURIComponent(dest);
                    
                    let daddr = encodedDest;
                    if (wp) {
                        const wpArr = wp.split('|').map(encodeURIComponent);
                        daddr = wpArr.join('+to:') + '+to:' + encodedDest;
                    }
                    embedUrl = `https://maps.google.com/maps?saddr=${encodedOrigin}&daddr=${daddr}&output=embed`;
                } else {
                    let query = u.searchParams.get('q') || u.searchParams.get('query');
                    if (!query && u.pathname.includes('/place/')) {
                        const parts = u.pathname.split('/place/');
                        if(parts.length > 1) query = decodeURIComponent(parts[1].split('/')[0]);
                    }
                    if (query) {
                        embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
                    } else {
                        shouldEmbed = false;
                    }
                }
            }
        } catch(e) {}
        
        if (shouldEmbed) {
            document.getElementById('content-iframe').src = embedUrl;
            document.getElementById('iframe-wrapper').classList.remove('hidden');
            if(window.innerWidth <= 768) window.scrollTo({top: 0, behavior: 'smooth'});
        } else {
            window.open(url, '_blank');
        }
    };

    window.closeIframe = () => {
        document.getElementById('iframe-wrapper').classList.add('hidden');
        document.getElementById('content-iframe').src = '';
    };

    window.openCurrentInNewTab = () => {
        if(currentIframeUrl) window.open(currentIframeUrl, '_blank');
    };

    // --- Helpers UI Modals ---
    window.showAlert = (title, msg) => {
        document.getElementById('alert-modal-title').innerText = title;
        document.getElementById('alert-modal-msg').innerText = msg;
        document.getElementById('alert-modal').classList.remove('hidden');
    };

    window.showConfirm = (title, msg, onConfirm) => {
        document.getElementById('confirm-modal-title').innerText = title;
        document.getElementById('confirm-modal-msg').innerText = msg;
        document.getElementById('confirm-modal').classList.remove('hidden');
        document.getElementById('confirm-modal-yes').onclick = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (onConfirm) onConfirm();
        };
    };

    // --- Daily Route Generation Logic ---
    window.openRouteModal = (dayIdx) => {
        const day = itinerary[dayIdx];
        let origin = day.location;
        let dest = day.location;
        
        if (day.title.includes('â†')) {
            const parts = day.title.split('â†').map(s => s.trim());
            origin = parts[0];
            dest = parts[1];
        }

        const waypoints = [];
        
        // 1. ×”×•×¡×¤×ª ×”××•×¤×¦×™×•×ª ×©× ×‘×—×¨×• (×”×¢×“×¤×” ×‘×¨×•×¨×” ×œ×©× ×‘×× ×’×œ×™×ª)
        const selOpts = window.selectedOptions[dayIdx] || [];
        const optIds = Array.isArray(selOpts) ? selOpts : [selOpts]; 
        
        optIds.forEach(optId => {
            if(!optId) return;
            let optSearchName = "";
            if (String(optId).startsWith('custom_')) {
                const cOpt = (window.customOptions[dayIdx] || []).find(o => o.id === optId);
                if (cOpt) optSearchName = cOpt.en_t || cOpt.t; // ×¢×“×™×¤×•×ª ×œ-en_t
            } else {
                const bOpt = (day.options || []).find(o => o.id === optId);
                const override = (window.baseOptOverrides[dayIdx] || {})[optId];
                if (override && !override.deleted) {
                    optSearchName = override.en_t || override.t;
                } else if (bOpt && !(override && override.deleted)) {
                    optSearchName = bOpt.en_t || bOpt.t;
                }
            }
            if (optSearchName) waypoints.push(optSearchName);
        });

        // 2. ×”×•×¡×¤×ª ×”×˜×™×¤×™× (×”×¢×“×¤×” ×œ×©× ×‘×× ×’×œ×™×ª)
        const tips = window.savedTips[dayIdx] || [];
        tips.forEach(t => waypoints.push(t.en_title || t.title));

        // ×‘× ×™×™×ª ×”×œ×™× ×§ ×œ××¡×œ×•×œ. ×× ×—× ×• ××©×¨×©×¨×™× "Vietnam" ×œ×›×œ × ×§×•×“×” ×›×“×™ ×œ×“×™×™×§ ××ª ×’×•×’×œ ××¤×•×ª
        const baseUrl = "https://www.google.com/maps/dir/?api=1";
        const originParam = encodeURIComponent(origin + " Vietnam");
        const destParam = encodeURIComponent(dest + " Vietnam");
        const wpParam = waypoints.length > 0 ? encodeURIComponent(waypoints.map(w => w + " Vietnam").join('|')) : "";
        
        let fullUrl = `${baseUrl}&origin=${originParam}&destination=${destParam}`;
        if (wpParam) fullUrl += `&waypoints=${wpParam}`;

        document.getElementById('route-modal-url').value = fullUrl;
        document.getElementById('route-modal').classList.remove('hidden');
    };

    window.handleRouteAction = async (action) => {
        const url = document.getElementById('route-modal-url').value;
        document.getElementById('route-modal').classList.add('hidden');
        
        if (action === 'browser') {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                textArea.remove();
            } catch(e) { console.warn("Copy to clipboard failed", e); }
            
            window.open(url, '_blank');
        } else if (action === 'iframe') {
            window.openInIframe(url);
        }
    };

    // --- Web Crypto API for Secure AES-GCM Encryption ---
    const SECRET_SALT = "Vietnam_Trip_AES_2026_SecureKey_!@#";
    
    async function getEncryptionKey() {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.digest("SHA-256", enc.encode(SECRET_SALT));
        return await window.crypto.subtle.importKey("raw", keyMaterial, "AES-GCM", false, ["encrypt", "decrypt"]);
    }

    async function encryptString(plainText) {
        if (!plainText) return "";
        try {
            const key = await getEncryptionKey();
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const enc = new TextEncoder();
            const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(plainText));
            
            const ivB64 = btoa(String.fromCharCode(...iv));
            const encB64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
            return `ENC_AES_GCM:${ivB64}:${encB64}`;
        } catch (e) {
            console.error("Encryption error:", e);
            return "";
        }
    }

    async function decryptString(encryptedPayload) {
        if (!encryptedPayload) return "";
        if (!encryptedPayload.startsWith("ENC_AES_GCM:")) return encryptedPayload;
        
        try {
            const parts = encryptedPayload.split(":");
            const iv = new Uint8Array(atob(parts[1]).split('').map(c => c.charCodeAt(0)));
            const encData = new Uint8Array(atob(parts[2]).split('').map(c => c.charCodeAt(0)));
            
            const key = await getEncryptionKey();
            const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, encData);
            const dec = new TextDecoder();
            return dec.decode(decrypted);
        } catch (e) {
            console.error("Decryption failed. Key corrupted?", e);
            return "";
        }
    }

    window.generateEncryptedFallback = async () => {
        const raw = document.getElementById('raw-fallback-input').value.trim();
        if(!raw) return;
        const enc = await encryptString(raw);
        const outBox = document.getElementById('encrypted-fallback-output');
        outBox.value = enc;
        outBox.select();
    };

    // ×—×™×œ×•×¥ ×ª×§×™×Ÿ ×•×××¤×” ×©×œ ×”×©× ×‘×× ×’×œ×™×ª
    const getEnglishLoc = (locCode) => {
        const mapping = {
            'hanoi': 'Hanoi',
            'sapa': 'Sapa',
            'ninhbinh': 'Ninh Binh',
            'hoian': 'Hoi An',
            'danang': 'Da Nang',
            'bachma': 'Bach Ma National Park',
            'halong': 'Lan Ha Bay / Ha Long Bay'
        };
        return mapping[locCode] || locCode || "";
    };

    // --- Data Model ---
    const itinerary = [
        { dayNum: 1, date: "30.03", title: "×”×’×¢×” ×œ×”×× ×•×™", location: "hanoi", desc: "× ×—×™×ª×” ×‘×¢×¨×‘, ×”×ª××¨×’× ×•×ª ×‘×¨×•×‘×¢ ×”×¢×ª×™×§.", links: [{t: "××¤×”", u: "https://www.google.com/maps?q=Hanoi+Old+Quarter"}] },
        { dayNum: 2, date: "31.03", title: "×”×× ×•×™ â† ×¡××¤×”", location: "sapa", desc: "× ×¡×™×¢×” ×©×œ 6 ×©×¢×•×ª ×‘×¨×›×‘ VIP ×œ×¡××¤×”.", options: [{id:"A",t:"×¨×›×‘×œ ×¤× ×¡×™×¤××Ÿ",en_t:"Fansipan Cable Car",d:"×ª×¦×¤×™×ª ××”×¤×¡×’×”",u:"https://sunworld.vn/en/fansipan"},{id:"B",t:"×›×¤×¨ ×§××˜ ×§××˜",en_t:"Cat Cat Village",d:"×˜×™×•×œ ×¨×’×œ×™ ×§×¦×¨",u:"https://www.google.com/maps?q=Cat+Cat+Village+Sapa"},{id:"C",t:"××§×©×Ÿ: ××•××’×”",d:"×—×‘×œ×™× ×•××§×©×Ÿ",u:"https://www.google.com/maps/search/zipline+near+Sapa"}] },
        { dayNum: 3, date: "01.04", title: "×¢××§ ××•××•× ×’ ×”×•××”", location: "sapa", desc: "×˜×¨×§ ×˜×¨×¡×•×ª ×”××•×¨×– ×”×§×œ××¡×™: Y Linh Ho â† Lao Chai â† Ta Van.", links: [{t: "Muong Hoa", u: "https://www.google.com/maps?q=Muong+Hoa+Valley"}] },
        { dayNum: 4, date: "02.04", title: "×¡××¤×” - ×™×•× ×˜×‘×¢ × ×•×¡×£", location: "sapa", desc: "×™×•× ×œ×‘×—×™×¨×” ××ª×•×š ×©×œ×•×© ××¤×©×¨×•×™×•×ª.", options: [{id:"A",t:"O Quy Ho + ××¤×œ×™×",en_t:"O Quy Ho Pass",d:"××¢×‘×¨ ×”×”×¨×™× ×”×’×‘×•×”",u:"https://www.google.com/maps?q=O+Quy+Ho+Pass"},{id:"B",t:"×˜×¨×§ + ×××‘×˜ ×¦××—×™×",en_t:"Giang Ta Chai",d:"×˜×¨×§ ×‘-Giang Ta Chai",u:"https://www.google.com/maps?q=Giang+Ta+Chai"},{id:"C",t:"×©×•×§ ×‘××§ ×”×",en_t:"Bac Ha Market",d:"×©×•×§ ×©×‘×˜×™× ×¦×‘×¢×•× ×™",u:"https://www.google.com/maps?q=Bac+Ha+Market"}] },
        { dayNum: 5, date: "03.04", title: "×¡××¤×” â† × ×™×Ÿ ×‘×™×Ÿ", location: "ninhbinh", desc: "× ×¡×™×¢×” ×“×¨×•××” ×•×¨×›×™×‘×” ×¢×œ ××•×¤× ×™×™× ×‘×˜×× ×§×•×§.", stay: "Ninh Binh Retreat", links: [{t: "×˜×× ×§×•×§", u: "https://www.google.com/maps?q=Tam+Coc"}] },
        { dayNum: 6, date: "04.04", title: "×–×¨×™×—×” ×‘× ×™×Ÿ ×‘×™×Ÿ ×•×˜×™×¡×”", location: "ninhbinh", desc: "×ª×¦×¤×™×ª ×”×× ×’ ××•××”, ×©×™×™×˜ ×•×˜×™×¡×ª ×¢×¨×‘ ×œ×“× ×× ×’.", links: [{t: "Hang Mua", u: "https://www.google.com/maps?q=Hang+Mua+viewpoint"}] },
        { dayNum: 7, date: "05.04", title: "×”×•×™ ××Ÿ - ×¢×™×¨ ×•×—×•×£", location: "hoian", desc: "×‘×•×§×¨ ×‘×—×•×£ An Bang. ××—×”\"×¦ ×‘×¢×™×¨ ×”×¢×ª×™×§×”.", links: [{t: "Ancient Town", u: "https://www.google.com/maps?q=Hoi+An+Ancient+Town"}] },
        { dayNum: 8, date: "06.04", title: "××™×™ ×¦'×× - ×©× ×•×¨×§×œ×™×", location: "hoian", desc: "×©×™×™×˜ ×©× ×•×¨×§×œ×™× ×‘××™ ×”×•×Ÿ ×œ××•.", links: [{t: "Cua Dai Port", u: "https://www.google.com/maps?q=Cua+Dai+Port"}] },
        { dayNum: 9, date: "07.04", title: "×˜×¨×§ ×‘××š ××”", location: "bachma", desc: "×™×•× ×˜×‘×¢ ×××ª×’×¨ ×‘×©××•×¨×”.", links: [{t: "Bach Ma NP", u: "https://www.bachmapark.com.vn/"}] },
        { dayNum: 10, date: "08.04", title: "×˜×™×¡×” â† ×§×¨×•×– ×‘××¤×¨×¥ ×œ××Ÿ ×”×", location: "halong", desc: "×˜×™×¡×ª ×‘×•×§×¨ ×œ×¦×¤×•×Ÿ ×•×™×¦×™××” ×œ×©×™×™×˜ ×©×œ 24 ×©×¢×•×ª ×‘××¤×¨×¥ ×œ××Ÿ ×”× (Lan Ha Bay).", stay: "×¡×¤×™× ×ª ×§×¨×•×–", links: [{t: "Lan Ha Bay", u: "https://www.google.com/maps?q=Lan+Ha+Bay"}] },
        { dayNum: 11, date: "09.04", title: "×¡×™×•× ×§×¨×•×– â† ×”×× ×•×™", location: "hanoi", desc: "×‘×•×§×¨ ×‘××¤×¨×¥, ×™×¨×™×“×” ××”×¡×¤×™× ×” ×‘×¦×”×¨×™×™× ×•× ×¡×™×¢×” ×œ×”×× ×•×™. ×‘×¢×¨×‘: ×¡×™×•×¨ ××•×›×œ ×¨×—×•×‘.", links: [{t: "×“×•× ×’ ×©×•××Ÿ", u: "https://www.google.com/maps?q=Dong+Xuan+Market"}] },
        { dayNum: 12, date: "10.04", title: "×”×× ×•×™ - buffer", location: "hanoi", desc: "×× ×•×—×” ×•×§× ×™×•×ª ×‘×¨×•×‘×¢ ×”×¢×ª×™×§.", links: [] },
        { dayNum: 13, date: "11.04", title: "×˜×™×¡×” ×”×‘×™×ª×”", location: "hanoi", desc: "×˜×™×¡×” ×‘-11:00.", links: [] }
    ];

    const locationsCoords = { 
        hanoi:[21.0285,105.8542], 
        sapa:[22.3333,103.8333], 
        ninhbinh:[20.2539,105.9750], 
        hoian:[15.8801,108.3380], 
        danang:[16.0544,108.2022], 
        bachma:[16.1969,107.8542], 
        halong:[20.7915,107.0543] 
    };

    // --- State ---
    window.savedTips = {}; 
    window.selectedOptions = {}; // { dayIdx: ['optId1', 'optId2'] }
    window.customOptions = {}; 
    window.baseOptOverrides = {}; 

    // --- Admin Modal Tab Logic ---
    window.switchAdminTab = (tab) => {
        ['config-gemini', 'config-openai', 'config-prompts', 'config-tools'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        ['tab-gemini', 'tab-openai', 'tab-prompts', 'tab-tools'].forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('active', 'text-indigo-600', 'border-indigo-600', 'bg-indigo-50');
            el.classList.add('text-gray-500', 'border-transparent');
        });
        
        document.getElementById('config-' + tab).classList.remove('hidden');
        const activeTab = document.getElementById('tab-' + tab);
        activeTab.classList.remove('text-gray-500', 'border-transparent');
        activeTab.classList.add('active', 'text-indigo-600', 'border-indigo-600', 'bg-indigo-50');

        const isApiTab = tab === 'gemini' || tab === 'openai';
        document.getElementById('provider-selector-box').style.display = isApiTab ? 'flex' : 'none';
        document.getElementById('btn-test-key').style.display = isApiTab ? 'block' : 'none';
        document.getElementById('test-key-result').classList.add('hidden');
    };

    // --- Config Logic ---
    window.saveAllConfig = async () => {
        const rawGemKey = document.getElementById('gemini-key-input').value.trim();
        const rawOaiKey = document.getElementById('openai-key-input').value.trim();
        
        const encGemKey = await encryptString(rawGemKey);
        const encOaiKey = await encryptString(rawOaiKey);

        const configs = {
            gemKeyEncrypted: encGemKey,
            gemMod: document.getElementById('gemini-model-select').value,
            oaiKeyEncrypted: encOaiKey,
            oaiMod: document.getElementById('openai-model-select').value,
            activeProvider: document.getElementById('active-provider-select').value,
            promptTips: document.getElementById('prompt-tips-input').value.trim(),
            promptOptions: document.getElementById('prompt-options-input').value.trim()
        };
        localStorage.setItem('vtn_crypto_config_v9', JSON.stringify(configs));
        window.closeApiModal();
    };

    window.loadConfigToUI = async () => {
        const d = JSON.parse(localStorage.getItem('vtn_crypto_config_v9') || "{}");
        if(d.gemKeyEncrypted) document.getElementById('gemini-key-input').value = await decryptString(d.gemKeyEncrypted);
        if(d.oaiKeyEncrypted) document.getElementById('openai-key-input').value = await decryptString(d.oaiKeyEncrypted);
        if(d.gemMod) document.getElementById('gemini-model-select').value = d.gemMod;
        if(d.oaiMod) document.getElementById('openai-model-select').value = d.oaiMod;
        if(d.activeProvider) document.getElementById('active-provider-select').value = d.activeProvider;
        
        document.getElementById('prompt-tips-input').value = d.promptTips || defaultTipsPrompt;
        document.getElementById('prompt-options-input').value = d.promptOptions || defaultOptionsPrompt;
    };

    window.getDecryptedConfig = async () => {
        const d = JSON.parse(localStorage.getItem('vtn_crypto_config_v9') || "{}");
        return {
            gemKey: await decryptString(d.gemKeyEncrypted),
            oaiKey: await decryptString(d.oaiKeyEncrypted),
            gemMod: d.gemMod || "gemini-1.5-flash-latest",
            oaiMod: d.oaiMod || "gpt-5.2",
            activeProvider: d.activeProvider || "gemini",
            promptTips: d.promptTips || defaultTipsPrompt,
            promptOptions: d.promptOptions || defaultOptionsPrompt
        };
    };

    // --- Google Drive Init & Auth ---
    window.initGIS = () => {
        window.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: async (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    accessToken = tokenResponse.access_token;
                    
                    const syncEl = document.getElementById('sync-status');
                    syncEl.innerText = 'â˜ï¸ ××—×•×‘×¨ ×œ-Drive';
                    syncEl.className = 'text-green-600 font-bold';
                    
                    const authBtn = document.getElementById('auth-btn');
                    authBtn.innerHTML = '×”×ª× ×ª×§ ××”×¢× ×Ÿ';
                    authBtn.classList.replace('bg-blue-100', 'bg-red-100');
                    authBtn.classList.replace('text-blue-700', 'text-red-700');
                    authBtn.onclick = window.logoutGoogle;
                    
                    await loadFromDrive();
                }
            },
        });
        
        const syncEl = document.getElementById('sync-status');
        const authBtn = document.getElementById('auth-btn');
        
        if (CLIENT_ID === "YOUR_GOOGLE_CLIENT_ID_HERE") {
             syncEl.innerText = 'âš ï¸ ××¦×‘ ××§×•××™ (Drive ×œ× ××•×’×“×¨)';
             syncEl.className = 'text-gray-500 font-bold';
             syncEl.title = '×¢×“×›×Ÿ ××ª CLIENT_ID ×‘×§×•×“ ×›×“×™ ×œ××¤×©×¨ ×’×™×‘×•×™ ×‘-Google Drive';
        } else {
             syncEl.innerText = 'â³ ××•×›×Ÿ ×œ×”×ª×—×‘×¨×•×ª...';
             authBtn.classList.remove('hidden');
        }
        
        const localData = JSON.parse(localStorage.getItem('vtn_local_tripData') || "{}");
        window.savedTips = localData.tips || {};
        window.selectedOptions = localData.options || {};
        window.customOptions = localData.customOptions || {};
        window.baseOptOverrides = localData.baseOptOverrides || {};
        
        // ×”×’×™×¨×” ×œ××‘× ×” ××¢×¨×š ×¢×‘×•×¨ ××¤×©×¨×•×™×•×ª × ×‘×—×¨×•×ª
        for(let k in window.selectedOptions) {
            if(!Array.isArray(window.selectedOptions[k])) window.selectedOptions[k] = [window.selectedOptions[k]];
        }

        itinerary.forEach((_, i) => { renderSavedTips(i); renderOptions(i); });
    };

    const gsiScript = document.createElement('script');
    gsiScript.src = 'https://accounts.google.com/gsi/client';
    gsiScript.async = true;
    gsiScript.defer = true;
    gsiScript.onload = window.initGIS;
    document.head.appendChild(gsiScript);

    window.loginGoogle = () => {
        if (!CLIENT_ID || CLIENT_ID === "YOUR_GOOGLE_CLIENT_ID_HERE") {
            window.showAlert("×”×ª×—×‘×¨×•×ª ×—×¡×¨×”", "×œ× ×”×•×’×“×¨ ××¤×ª×— ×”×ª×—×‘×¨×•×ª ×œ×’×•×’×œ (CLIENT_ID) ×‘×§×•×“.\n×”××¤×œ×™×§×¦×™×” ×ª××©×™×š ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×¢×œ ×”××›×©×™×¨ ×”××§×•××™ ×‘×œ×‘×“.");
            return;
        }
        window.tokenClient.requestAccessToken();
    };

    window.logoutGoogle = () => {
        accessToken = null;
        driveFolderId = null;
        driveFileId = null;
        const syncEl = document.getElementById('sync-status');
        syncEl.innerText = 'âš ï¸ ××¦×‘ ××§×•××™ (×× ×•×ª×§ ××”×¢× ×Ÿ)';
        syncEl.className = 'text-gray-500 font-bold';
        
        const authBtn = document.getElementById('auth-btn');
        authBtn.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg> ×”×ª×—×‘×¨ ×¢× Google`;
        authBtn.classList.replace('bg-red-100', 'bg-blue-100');
        authBtn.classList.replace('text-red-700', 'text-blue-700');
        authBtn.onclick = window.loginGoogle;
    };

    // --- Google Drive API Logic ---
    async function loadFromDrive() {
        if (!accessToken) return;
        try {
            document.getElementById('sync-status').innerText = 'â³ ××—×¤×© ×ª×™×§×™×™×”...';
            
            const folderQuery = encodeURIComponent(`name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
            const searchFolderRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${folderQuery}&spaces=drive`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const folderData = await searchFolderRes.json();
            
            if (folderData.files && folderData.files.length > 0) {
                driveFolderId = folderData.files[0].id;
                
                document.getElementById('sync-status').innerText = 'â³ ××•×©×š × ×ª×•× ×™×...';
                const fileQuery = encodeURIComponent(`name='${FILE_NAME}' and '${driveFolderId}' in parents and trashed=false`);
                const searchFileRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${fileQuery}&spaces=drive`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const fileData = await searchFileRes.json();
                
                if (fileData.files && fileData.files.length > 0) {
                    driveFileId = fileData.files[0].id;
                    
                    const readRes = await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const d = await readRes.json();
                    
                    window.savedTips = d.tips || {};
                    window.selectedOptions = d.options || {};
                    window.customOptions = d.customOptions || {};
                    window.baseOptOverrides = d.baseOptOverrides || {};
                    
                    for(let k in window.selectedOptions) {
                        if(!Array.isArray(window.selectedOptions[k])) window.selectedOptions[k] = [window.selectedOptions[k]];
                    }

                    itinerary.forEach((_, i) => { 
                        renderSavedTips(i); 
                        renderOptions(i); 
                    });
                }
            } else {
                console.log("Folder not found. Will be created on first save.");
            }
            document.getElementById('sync-status').innerText = 'â˜ï¸ ××¡×•× ×›×¨×Ÿ ×‘-Drive';
        } catch(e) { 
            console.error("Load from Drive failed:", e); 
            document.getElementById('sync-status').innerText = 'âš ï¸ ×©×’×™××ª ×§×¨×™××” ××”×¢× ×Ÿ'; 
        }
    }

    async function syncToCloud() {
        const payload = { 
            tips: window.savedTips, 
            options: window.selectedOptions, 
            customOptions: window.customOptions,
            baseOptOverrides: window.baseOptOverrides
        };
        
        if (!accessToken) {
            localStorage.setItem('vtn_local_tripData', JSON.stringify(payload));
            const syncStatusEl = document.getElementById('sync-status');
            if(syncStatusEl && CLIENT_ID !== "YOUR_GOOGLE_CLIENT_ID_HERE") {
                syncStatusEl.innerText = 'ğŸ’¾ × ×©××¨ ××§×•××™×ª';
            }
            return;
        }

        try {
            document.getElementById('sync-status').innerText = 'â³ ×©×•××¨ ×‘-Drive...';
            const fileContent = JSON.stringify(payload);
            
            if (!driveFolderId) {
                const folderRes = await fetch(`https://www.googleapis.com/drive/v3/files`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' })
                });
                const folderData = await folderRes.json();
                driveFolderId = folderData.id;
            }

            if (driveFileId) {
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: fileContent
                });
            } else {
                const metaRes = await fetch(`https://www.googleapis.com/drive/v3/files`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: FILE_NAME, mimeType: 'application/json', parents: [driveFolderId] })
                });
                const metaData = await metaRes.json();
                driveFileId = metaData.id;
                
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: fileContent
                });
            }
            
            document.getElementById('sync-status').innerText = 'â˜ï¸ × ×©××¨ ×‘-Drive';
        } catch(e) { 
            console.error("Save to Drive failed:", e); 
            document.getElementById('sync-status').innerText = 'âš ï¸ ×©×’×™××ª ×©××™×¨×”'; 
        }
    }

    // --- AI API & Generation Logic ---
    window.testActiveApiKey = async () => {
        const prov = document.getElementById('active-provider-select').value;
        const key = document.getElementById(prov + '-key-input').value.trim();
        const mod = document.getElementById(prov + '-model-select').value;
        const resBox = document.getElementById('test-key-result');
        
        if (!key) {
            resBox.className = "mb-4 p-3 rounded-xl text-xs font-bold text-center bg-red-100 text-red-700";
            resBox.innerText = "×× × ×”×–×Ÿ ××¤×ª×— API ×ª×—×™×œ×”!";
            resBox.classList.remove('hidden');
            return;
        }

        resBox.className = "mb-4 p-3 rounded-xl text-xs font-bold text-center bg-gray-100 text-gray-700";
        resBox.innerText = `×‘×•×“×§ ××•×œ ${prov}...`; resBox.classList.remove('hidden');

        try {
            let res, d;
            if(prov==='gemini'){
                res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${mod}:generateContent?key=${key}`, { method:'POST', body: JSON.stringify({ contents: [{ parts: [{ text: "hi" }] }] }) });
            } else {
                res = await fetch(`https://api.openai.com/v1/chat/completions`, { method:'POST', headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'}, body: JSON.stringify({ model:mod, messages:[{role:"user",content:"hi"}], max_completion_tokens:5 }) });
            }
            d = await res.json();
            if(res.ok) { resBox.innerText = "×”××¤×ª×— ×ª×§×™×Ÿ!"; resBox.classList.replace('bg-gray-100','bg-green-100'); resBox.classList.replace('text-gray-700','text-green-800'); }
            else throw new Error(d.error?.message || "×©×’×™××” ××”×©×¨×ª");
        } catch(e) { resBox.innerText = e.message; resBox.classList.replace('bg-gray-100','bg-red-100'); resBox.classList.replace('text-gray-700','text-red-800'); }
    };

    window.openAIGuide = async (dayIdx, mode = 'tips') => {
        const c = await window.getDecryptedConfig();
        let prov = c.activeProvider;
        let key = prov === 'gemini' ? c.gemKey : c.oaiKey;
        let mod = prov === 'gemini' ? c.gemMod : c.oaiMod;
        
        const hasFallbackStr = typeof FALLBACK_OAI_KEY !== 'undefined' && FALLBACK_OAI_KEY && FALLBACK_OAI_KEY !== "YOUR_LIMITED_OPENAI_KEY_HERE";
        if (!key && hasFallbackStr) {
            prov = 'openai';
            mod = 'gpt-4o-mini';
            if (FALLBACK_OAI_KEY.startsWith("ENC_AES_GCM:")) {
                key = await decryptString(FALLBACK_OAI_KEY);
            } else {
                key = FALLBACK_OAI_KEY;
            }
        }

        if(!key) { window.openApiModal(); return; }

        window.currentAIDayIndex = dayIdx;
        const day = itinerary[dayIdx];
        const isOptionsMode = mode === 'options';
        const modeLabel = isOptionsMode ? '××¤×©×¨×•×™×•×ª ××¡×œ×•×œ' : '×˜×™×¤×™× ×œ×™×¢×“';
        
        document.getElementById('active-provider-label').innerText = `${prov.toUpperCase()} - ${modeLabel}`;
        document.getElementById('ai-overlay').classList.add('open');
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-results').classList.add('hidden');
        document.getElementById('ai-error-box').classList.add('hidden');

        let origin = "";
        let dest = day.title;
        if(day.title.includes('â†')) {
            const parts = day.title.split('â†').map(s => s.trim());
            origin = parts[0];
            dest = parts[1];
        }

        let rawPromptTemplate = isOptionsMode ? c.promptOptions : c.promptTips;
        
        let enLoc = getEnglishLoc(day.location);

        let prompt = rawPromptTemplate
            .replace(/<×©×_×‘×× ×’×œ×™×ª>/g, enLoc)
            .replace(/<English name>/g, enLoc) 
            .replace(/<×™×¢×“>/g, dest || day.title)
            .replace(/<××•×¦×>/g, origin || "")
            .replace(/<×ª××¨×™×š>/g, day.date || "")
            .replace(/<×ª×™××•×¨>/g, day.desc || "");

        const selectedOptsArr = window.selectedOptions[dayIdx] || [];
        if (!isOptionsMode && selectedOptsArr.length > 0) {
            prompt += `\nSelected Options IDs: ${selectedOptsArr.join(', ')}`;
        }

        try {
            let res, d;
            const sysInstruction = "You are a local expert guide. You must strictly reply in valid JSON format only, matching the exact requested structure.";
            
            if(prov==='gemini'){
                res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${mod}:generateContent?key=${key}`, { method:'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: sysInstruction }] }, generationConfig: { responseMimeType: "application/json" } }) });
            } else {
                res = await fetch(`https://api.openai.com/v1/chat/completions`, { method:'POST', headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'}, body: JSON.stringify({ model:mod, messages:[{role:"system",content:sysInstruction}, {role:"user",content:prompt}], response_format:{type:"json_object"} }) });
            }
            d = await res.json();
            if(!res.ok) { document.getElementById('error-content').innerText = JSON.stringify(d, null, 2); document.getElementById('ai-error-box').classList.remove('hidden'); document.getElementById('ai-loading').classList.add('hidden'); return; }
            
            const raw = prov === 'gemini' ? d.candidates[0].content.parts[0].text : d.choices[0].message.content;
            const result = JSON.parse(raw);
            
            if (isOptionsMode) {
                window.currentAIOptions = result.options;
                document.getElementById('ai-results').innerHTML = `<h4 class="font-bold text-lg mb-4 text-teal-800">×”×¦×¢×•×ª ××•×ª×××•×ª ××™×©×™×ª - ${day.title}</h4>` + result.options.map((o, i) => `
                    <div class="bg-white p-4 rounded-xl border mb-3 shadow-sm text-right border-teal-100">
                        <h5 class="font-bold text-sm mb-1">${o.t} <span class="text-[10px] text-gray-500 font-normal dir-ltr inline-block">(${o.en_t || ''})</span></h5>
                        <p class="text-xs text-gray-600 mb-3">${o.d}</p>
                        <div class="flex flex-row-reverse justify-between items-center">
                            ${o.u ? `<button onclick="window.openInIframe('${(o.u || '').replace(/'/g, "\\'")}')" class="text-teal-600 text-[10px] font-bold underline">××¤×”/××ª×¨</button>` : '<span></span>'}
                            <button onclick="window.saveGeneratedOption(${i}, this)" class="bg-teal-50 text-teal-700 px-3 py-1.5 rounded-full text-[10px] font-bold hover:bg-teal-100 transition-colors shadow-sm">â• ×”×•×¡×£ ×›××¤×©×¨×•×ª</button>
                        </div>
                    </div>`).join('');
            } else {
                window.currentAITips = result.tips;
                document.getElementById('ai-results').innerHTML = `<h4 class="font-bold text-lg mb-4 text-indigo-800">×˜×™×¤×™× ×œ${dest || day.location}</h4>` + result.tips.map((t, i) => {
                    const searchName = t.en_title || t.title;
                    const mapQuery = encodeURIComponent(`${searchName} ${dest || day.location} Vietnam`);
                    const finalUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;
                    return `
                    <div class="bg-white p-4 rounded-xl border mb-3 shadow-sm text-right border-indigo-100">
                        <div class="flex flex-row-reverse gap-3">
                            <div class="text-2xl">${t.emoji}</div>
                            <div class="flex-1">
                                <h5 class="font-bold text-sm mb-1">${t.title} <span class="text-[10px] text-gray-500 font-normal dir-ltr inline-block">(${t.en_title || ''})</span></h5>
                                <p class="text-xs text-gray-600 mb-3">${t.text}</p>
                                <div class="flex flex-row-reverse justify-between items-center">
                                    <button onclick="window.openInIframe('${finalUrl.replace(/'/g, "\\'")}')" class="text-indigo-600 text-[10px] font-bold underline">××¤×”</button>
                                    <button onclick="window.saveTip(${i}, this)" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-bold hover:bg-indigo-100 transition-colors">â­ ×©××•×¨ ×˜×™×¤</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-results').classList.remove('hidden');
        } catch(e) { document.getElementById('error-content').innerText = e.message; document.getElementById('ai-error-box').classList.remove('hidden'); document.getElementById('ai-loading').classList.add('hidden'); }
    };

    // --- Options & Custom Features Logic ---
    window.saveGeneratedOption = (idx, btn) => {
        const opt = window.currentAIOptions[idx];
        const dayIdx = window.currentAIDayIndex;
        if(!window.customOptions[dayIdx]) window.customOptions[dayIdx] = [];
        
        const newId = 'custom_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        
        window.customOptions[dayIdx].push({ id: newId, t: opt.t, en_t: opt.en_t, d: opt.d, u: opt.u });
        renderOptions(dayIdx);
        syncToCloud();
        
        btn.innerText = "âœ… ×”×•×¡×£ ×‘×”×¦×œ×—×”";
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    };

    window.openAddManualOption = (dayIdx) => {
        document.getElementById('edit-opt-dayidx').value = dayIdx;
        document.getElementById('edit-opt-id').value = ''; 
        document.getElementById('edit-opt-t').value = '';
        document.getElementById('edit-opt-en-t').value = '';
        document.getElementById('edit-opt-d').value = '';
        document.getElementById('edit-opt-u').value = '';
        document.getElementById('edit-option-modal-title').innerText = "×”×•×¡×¤×ª ×¤×¢×™×œ×•×ª ×™×“× ×™×ª";
        document.getElementById('edit-option-modal').classList.remove('hidden');
    };

    window.openEditOption = (dayIdx, optId) => {
        let opt;
        if (String(optId).startsWith('custom_')) {
            opt = (window.customOptions[dayIdx] || []).find(o => o.id === optId);
        } else {
            const baseOpt = (itinerary[dayIdx].options || []).find(o => o.id === optId);
            const override = (window.baseOptOverrides[dayIdx] || {})[optId] || {};
            opt = {
                t: override.t || baseOpt.t,
                en_t: override.en_t || baseOpt.en_t,
                d: override.d || baseOpt.d,
                u: override.u || baseOpt.u
            };
        }
        if(!opt) return;
        document.getElementById('edit-opt-dayidx').value = dayIdx;
        document.getElementById('edit-opt-id').value = optId;
        document.getElementById('edit-opt-t').value = opt.t || '';
        document.getElementById('edit-opt-en-t').value = opt.en_t || '';
        document.getElementById('edit-opt-d').value = opt.d || '';
        document.getElementById('edit-opt-u').value = opt.u || '';
        document.getElementById('edit-option-modal-title').innerText = "×¢×¨×™×›×ª ××¤×©×¨×•×ª ×¤×¢×™×œ×•×ª";
        document.getElementById('edit-option-modal').classList.remove('hidden');
    };

    window.closeEditModal = () => document.getElementById('edit-option-modal').classList.add('hidden');

    window.saveEditedOption = () => {
        const dayIdx = document.getElementById('edit-opt-dayidx').value;
        const optId = document.getElementById('edit-opt-id').value;
        const newT = document.getElementById('edit-opt-t').value;
        const newEnT = document.getElementById('edit-opt-en-t').value;
        const newD = document.getElementById('edit-opt-d').value;
        const newU = document.getElementById('edit-opt-u').value;

        if (!optId) {
            if(!window.customOptions[dayIdx]) window.customOptions[dayIdx] = [];
            const newId = 'custom_' + Date.now() + '_' + Math.floor(Math.random()*1000);
            window.customOptions[dayIdx].push({ id: newId, t: newT, en_t: newEnT, d: newD, u: newU });
        } else if (String(optId).startsWith('custom_')) {
            const arr = window.customOptions[dayIdx];
            if(arr) {
                const idx = arr.findIndex(o => o.id === optId);
                if(idx !== -1) {
                    arr[idx].t = newT;
                    arr[idx].en_t = newEnT;
                    arr[idx].d = newD;
                    arr[idx].u = newU;
                }
            }
        } else {
            if(!window.baseOptOverrides[dayIdx]) window.baseOptOverrides[dayIdx] = {};
            window.baseOptOverrides[dayIdx][optId] = { t: newT, en_t: newEnT, d: newD, u: newU };
        }
        
        renderOptions(dayIdx);
        syncToCloud();
        window.closeEditModal();
    };

    window.deleteOption = (dayIdx, optId) => {
        window.showConfirm("××—×™×§×ª ××¤×©×¨×•×ª", "×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¢×™×œ×•×ª ×–×•?", () => {
            if(String(optId).startsWith('custom_')) {
                if(window.customOptions[dayIdx]) {
                    window.customOptions[dayIdx] = window.customOptions[dayIdx].filter(o => o.id !== optId);
                }
            } else {
                if(!window.baseOptOverrides[dayIdx]) window.baseOptOverrides[dayIdx] = {};
                window.baseOptOverrides[dayIdx][optId] = { deleted: true };
            }

            if(window.selectedOptions[dayIdx]) {
                window.selectedOptions[dayIdx] = window.selectedOptions[dayIdx].filter(id => id !== optId);
            }
            
            renderOptions(dayIdx);
            syncToCloud();
        });
    };
    
    window.deleteTip = (dayIdx, tipIdx) => {
        window.showConfirm("××—×™×§×ª ×˜×™×¤", "×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×˜×™×¤ ×–×” ×××•×¢×“×¤×™×?", () => {
            if(window.savedTips[dayIdx]) {
                window.savedTips[dayIdx].splice(tipIdx, 1);
            }
            renderSavedTips(dayIdx);
            syncToCloud();
        });
    };

    // --- UI/Map Implementation ---
    const map = L.map('map', { zoomControl: false }).setView([16.5, 107.5], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© CARTO' }).addTo(map);
    L.polyline([[21,105],[22,103],[21,105],[20,105],[15,108],[16,107],[15,108],[20.79,107.05],[21.02,105.85]], { color: '#4f46e5', weight: 3, opacity: 0.3, dashArray: '6, 8' }).addTo(map);

    Object.keys(locationsCoords).forEach((k, i) => {
        L.marker(locationsCoords[k], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div>${i+1}</div>`, iconSize:[30,30] }) }).addTo(map).on('click', () => {
            const idx = itinerary.findIndex(d => d.location === k);
            if(idx !== -1) {
                document.getElementById(`day-card-${idx}`).scrollIntoView({ behavior: 'smooth' });
                window.closeAIPanel();
            }
        });
    });

    const container = document.getElementById('timeline-container');
    itinerary.forEach((day, idx) => {
        const card = document.createElement('div');
        card.className = 'day-card'; card.id = `day-card-${idx}`;
        card.innerHTML = `
            <div class="day-dot"></div>
            <div class="text-sm font-bold text-indigo-700 mb-1.5">×™×•× ${day.dayNum} â€¢ ${day.date}</div>
            <h3 class="text-xl font-black text-gray-900 mb-1.5">${day.title}</h3>
            <p class="text-[15px] text-gray-600 mb-4 leading-relaxed font-medium">${day.desc}</p>
            <div id="options-area-${idx}" class="mb-4"></div>
            ${day.stay ? `<div class="bg-orange-50 p-2.5 rounded-lg text-xs my-2 border border-orange-200 text-orange-900 font-bold shadow-sm">ğŸ¨ ${day.stay}</div>` : ''}
            <div class="flex flex-wrap gap-2 my-2">${(day.links || []).map(l => `<button onclick="window.openInIframe('${(l.u || '').replace(/'/g, "\\'")}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-full text-[11px] font-bold shadow-sm hover:bg-gray-50 hover:text-gray-900 transition-colors">${l.t}</button>`).join('')}</div>
            <div id="saved-tips-area-${idx}"></div>
            <div class="flex flex-wrap gap-2 mt-5">
                <button onclick="window.openAIGuide(${idx}, 'tips')" class="flex-1 min-w-[110px] max-w-[160px] text-[11px] font-bold text-indigo-800 py-2.5 px-2 bg-indigo-50 border border-indigo-200 rounded-xl hover:bg-indigo-100 transition-colors flex justify-center items-center gap-1 shadow-sm"><span>âœ¨</span> ×˜×™×¤×™× ×œ×™×¢×“</button>
                <button onclick="window.openAIGuide(${idx}, 'options')" class="flex-1 min-w-[110px] max-w-[160px] text-[11px] font-bold text-teal-800 py-2.5 px-2 bg-teal-50 border border-teal-200 rounded-xl hover:bg-teal-100 transition-colors flex justify-center items-center gap-1 shadow-sm"><span>ğŸ¯</span> AI ××¤×©×¨×•×™×•×ª</button>
                <button onclick="window.openAddManualOption(${idx})" class="flex-1 min-w-[110px] max-w-[160px] text-[11px] font-bold text-gray-800 py-2.5 px-2 bg-gray-50 border border-gray-300 rounded-xl hover:bg-gray-100 transition-colors flex justify-center items-center gap-1 shadow-sm"><span>âœï¸</span> ×”×•×¡×£ ×™×“× ×™×ª</button>
                <button onclick="window.openRouteModal(${idx})" class="flex-1 min-w-[110px] max-w-[160px] text-[11px] font-bold text-blue-800 py-2.5 px-2 bg-blue-50 border border-blue-200 rounded-xl hover:bg-blue-100 transition-colors flex justify-center items-center gap-1 shadow-sm"><span>ğŸ—ºï¸</span> ××¡×œ×•×œ ××¤×”</button>
            </div>
        `;
        container.appendChild(card);
        renderOptions(idx);
    });

    function renderOptions(dayIdx) {
        const area = document.getElementById(`options-area-${dayIdx}`);
        const day = itinerary[dayIdx];
        
        const overrides = window.baseOptOverrides[dayIdx] || {};
        const rawBaseOpts = day.options || [];
        
        const baseOpts = rawBaseOpts
            .filter(o => !(overrides[o.id] && overrides[o.id].deleted))
            .map(o => {
                if (overrides[o.id]) {
                    return { ...o, t: overrides[o.id].t || o.t, en_t: overrides[o.id].en_t || o.en_t, d: overrides[o.id].d || o.d, u: overrides[o.id].u || o.u };
                }
                return o;
            });

        const customOpts = window.customOptions[dayIdx] || [];
        const allOpts = [...baseOpts, ...customOpts];
        
        if(allOpts.length === 0) { area.innerHTML = ''; return; }
        
        area.innerHTML = `<p class="text-xs font-bold text-gray-500 mb-2.5">××¤×©×¨×•×™×•×ª ××¡×œ×•×œ ×œ×™×•× ×–×” (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××”):</p>` + allOpts.map(o => {
            const isCustom = String(o.id).startsWith('custom_');
            const displayId = isCustom ? 'âœ¨' : o.id + '.';
            const isSelected = window.selectedOptions[dayIdx] && window.selectedOptions[dayIdx].includes(o.id);
            const dispTitle = o.en_t ? `${o.t} <span class="text-xs text-gray-400 font-normal dir-ltr inline-block">(${o.en_t})</span>` : o.t;
            
            return `
            <div onclick="window.selectOption(${dayIdx}, '${o.id}')" class="option-box ${isSelected ? 'selected' : ''}">
                <div class="w-5 h-5 rounded-md border-2 flex items-center justify-center shrink-0 mt-0.5 border-gray-300 ${isSelected ? 'border-indigo-600 bg-indigo-600' : ''}">
                    ${isSelected ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </div>
                <div class="flex-1 text-right">
                    <span class="font-bold text-[15px] text-gray-900">${displayId} ${dispTitle}</span>
                    <p class="text-sm text-gray-600 leading-relaxed mt-1.5 font-medium">${o.d}</p>
                </div>
                <div class="flex flex-col gap-1.5 items-center mr-3" onclick="event.stopPropagation()">
                    ${o.u ? `<button onclick="event.stopPropagation(); window.openInIframe('${(o.u || '').replace(/'/g, "\\'")}')" title="×¤×ª×— ×§×™×©×•×¨" class="text-indigo-500 p-1.5 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>` : '<div></div>'}
                    <button onclick="window.openEditOption(${dayIdx}, '${o.id}')" title="×¢×¨×•×š" class="text-blue-500 p-1.5 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                    <button onclick="window.deleteOption(${dayIdx}, '${o.id}')" title="××—×§" class="text-red-500 p-1.5 bg-red-50 rounded-lg hover:bg-red-100 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
            </div>`;
        }).join('');
    }

    window.selectOption = (idx, id) => {
        if (!window.selectedOptions[idx]) window.selectedOptions[idx] = [];
        if (!Array.isArray(window.selectedOptions[idx])) window.selectedOptions[idx] = [window.selectedOptions[idx]];

        const arr = window.selectedOptions[idx];
        const pos = arr.indexOf(id);
        
        if (pos > -1) {
            arr.splice(pos, 1); 
        } else {
            arr.push(id); 
        }

        renderOptions(idx); 
        syncToCloud();      
    };

    window.saveTip = (i, btn) => {
        const tip = window.currentAITips[i];
        if(!window.savedTips[window.currentAIDayIndex]) window.savedTips[window.currentAIDayIndex] = [];
        window.savedTips[window.currentAIDayIndex].push(tip);
        renderSavedTips(window.currentAIDayIndex);
        syncToCloud();
        btn.innerText = "âœ… × ×©××¨";
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    };

    function renderSavedTips(idx) {
        const area = document.getElementById(`saved-tips-area-${idx}`);
        const tips = window.savedTips[idx] || [];
        
        area.innerHTML = tips.map((t, tipIdx) => {
            const searchName = t.en_title || t.title;
            const mapQuery = encodeURIComponent(`${searchName} Vietnam`);
            const finalUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;
            const dispTitle = t.en_title ? `${t.title} <span class="text-[10px] text-gray-500 font-normal dir-ltr inline-block">(${t.en_title})</span>` : t.title;
            
            return `<div class="bg-indigo-50 border border-indigo-200 p-3 rounded-lg mt-2 flex flex-row-reverse justify-between items-center text-xs shadow-sm">
                <span class="font-bold text-indigo-900">${t.emoji} ${dispTitle}</span>
                <div class="flex items-center gap-4" onclick="event.stopPropagation()">
                    <button onclick="window.openInIframe('${finalUrl.replace(/'/g, "\\'")}')" class="text-indigo-700 font-bold underline hover:text-indigo-900 transition-colors">××¤×”</button>
                    <button onclick="window.deleteTip(${idx}, ${tipIdx})" class="text-red-500 hover:text-red-700 transition-colors" title="××—×§ ×˜×™×¤">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    // --- Modal Logic ---
    window.openApiModal = async () => { document.getElementById('api-key-modal').classList.remove('hidden'); await window.loadConfigToUI(); };
    window.closeApiModal = () => document.getElementById('api-key-modal').classList.add('hidden');
    window.closeAIPanel = () => document.getElementById('ai-overlay').classList.remove('open');

    // --- Resizer ---
    let rsz = false;
    document.getElementById('resizer').addEventListener('mousedown', () => rsz = true);
    document.addEventListener('mouseup', () => rsz = false);
    document.addEventListener('mousemove', (e) => {
        if(!rsz) return;
        if(window.innerWidth > 768) {
            let newWidth = window.innerWidth - e.clientX;
            if(newWidth < 380) newWidth = 380;
            if(newWidth > window.innerWidth) newWidth = window.innerWidth;
            document.getElementById('itinerary-container').style.width = newWidth + 'px';
        }
        else {
            document.getElementById('map-container').style.height = e.clientY + 'px';
        }
        map.invalidateSize();
    });
</script>
</body>
</html>
